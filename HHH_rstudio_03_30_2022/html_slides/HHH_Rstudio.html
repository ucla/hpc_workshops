<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Hoffman2 Happy Hour: Using RStudio on Hoffman2</title>
    <meta charset="utf-8" />
    <meta name="author" content="Charles Peterson" />
    <script src="HHH_Rstudio_files/header-attrs-2.13/header-attrs.js"></script>
    <script src="HHH_Rstudio_files/clipboard-2.0.6/clipboard.min.js"></script>
    <link href="HHH_Rstudio_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="HHH_Rstudio_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Hoffman2 Happy Hour: Using RStudio on Hoffman2
### Charles Peterson
### 03-30-2022

---








## Hoffman2 Happy Hours

Welcome to the Hoffman2 Happy Hours

Short-ish presentations on a certain topic related to HPC and Hoffman2

.pull-left[

Any thoughts on what I should do for future "Happy Hour" talks?

cpeterson@oarc.ucla.edu

]

.pull-right[

![mypic](mypic.jpg)
]

---

## Files for this Presentation

This presentation can be found on github under `HHH_rstudio_03_30_2022` folder

&lt;https://github.com/ucla/hpc_workshops&gt;

RStudio files and information for this presentation can be found also on
github under the `rstudio` folder

&lt;https://github.com/charliecpeterson/H2_software&gt;

---

## What is RStudio

If you are here, you most likely know what RStudio is and have used it
before.

--
.center[
.pull-left[
But why do you want to use RStudio on Hoffman2 when you can use your own computer???
]
]
--
.pull-right[
You may want to use Hoffman2 to access cluster resources, higher memory, multi-core, GPUs.

You can also access data that is already on Hoffman2.
]

--

.center[
There are two main (free) RStudio IDEs that researchers can use
]

--
.pull-left[
### RStudio Desktop

This IDE is install locally on your machine.

This is a standalone desktop application.
]

--
.pull-right[
### RStudio Server

This IDE requires a remote server to run a RStudio Server process, that
you can connect and run on a local web browser
]

---

## RStudio Server

While we do have a RStudio Desktop version on Hoffman2, this would
require X11 forwarding to display RStudio on a local machine. This can
be very slow and the interactive maybe sluggish depending on your
connection.

**RStudio Server** is the best way to use RStudio on Hoffman2

--

Hoffman2 has a container that has R/Rstudio that can be ran on with
Apptainer/Singularity

For more information on using containers, there is a Workshop [Using
Containers on HPC
resources](https://idre.ucla.edu/calendar-event/using-container-on-hpc-resources)
on Apr 20, 2022

This container is an isolate image and has it's own version of R and RStudio that is unrelated
to the versions of R that was built on Hoffman2.

&lt;p align = "center"&gt; &lt;img src="rstudio.png" width="20%"&gt; &lt;/p&gt; &lt;p align = "center"&gt; rstudio.com&lt;/p&gt;

---

## Running RStudio

Steps to run RStudio on Hoffman2

### Get an interactive job
.pull-left[
You cannot run containers on login nodes. You **MUST** use a compute
node
]
.pull-right[


```bash
qrsh -l h_data=10G
```
]

--

### Create temp directories


RStudio server requires you to have writable tmp directories to run
properly

You can have this directories anywhere you have write access


```bash
mkdir -pv $SCRATCH/rstudiotmp/var/lib
mkdir -pv $SCRATCH/rstudiotmp/var/run
mkdir -pv $SCRATCH/rstudiotmp/tmp
```

---

## Running RStudio

### Load Apptainer

.pull-left[
Apptainer is software that will run the Rstudio container
]

.pull-right[


```bash
module load apptainer/1.0.0
```
]

--
--- 

### Start up RStudio


```bash
apptainer run \
 -B $SCRATCH/rstudiotmp/var/lib:/var/lib/rstudio-server \
 -B $SCRATCH/rstudiotmp/var/run:/var/run/rstudio-server \
 -B $SCRATCH/rstudiotmp/tmp:/tmp \
 $H2_CONTAINER_LOC/h2-rstudio_4.1.0.sif
```

This this point, RStudio will start to run on the compute node. You will see information about this RStudio session. You will need to take note of **compute node name** and **port number**. KEEP THIS TERMINAL OPEN.

This will also display an `ssh -N -L ...` command that you will need to run

---

## Running RStudio

### Open another terminal on your local computer

You will need to run a port forward command to create a connection to the
RStudio server running on the compute node, to your local computer.


```bash
ssh  -L 8787:nXXX:8787 H2USERNAME@hoffman2.idre.ucla.edu 
# Or whatever command was displayed earlier
```

Finally, open a web browser


```bash
http://localhost:8787
# Or whatever port number that was displayed
```

---

## Running Rstudio - the easy way

We have created a script that will run everything from the previous
slide automatically.

User can run the `h2_rstudio.sh` script on their **local machine** to
setup RStudio.


```bash
wget https://raw.githubusercontent.com/charliecpeterson/H2_software/master/rstudio/h2_rstudio.sh
```

To display how to use this script:


```bash
./h2_rstudio.sh -h
```

Typically, you will run this script by providing your Hoffman2 user name


```bash
./h2_rstudio.sh -u H2USERNAME
```

This will start RStudio by running all the necessary steps and open a
web browser to the correct port to Hoffman2

---

# RStudio Script

.center[
![](rstudio_script.gif)
]

RStudio Script, currently on GitHub under `rstudio` folder

https://github.com/charliecpeterson/H2_software

---

## Information on this RStudio Container

This Rstudio container will built using Docker. You can find all containers built for Hoffman2
located at `$H2_CONTAINER_LOC`. The RStudio container used here is named `h2-rstudio_4.1.0.sif`

All **Dockerfiles** that the container where built for Hoffman2 are located at
&lt;https://github.com/charliecpeterson/containers/tree/master/docker/hoffman&gt;

This container has it's build of R and when you install packages, it
will install by default to `~/R/APPTAINER/h2-rstudio_4.1.0`.

If your R packages require extra libraries or software let us know and
we can update this container. OR you can modify the RStudio Dockerfile
and create your own container.

This Dockerfile uses RStudio images from the [Rocker
Project](https://www.rocker-project.org) as a base. 

I'm currently working on creating custom Rstudio/R images so we can have different
versions of R and Rstudio.

---

## Tips for running RStudio

--

- If Rstudio has problems startup, maybe clear our any tmp or config files from previous Rstudio run


```bash
rm -rf ~/.config/rstudio
rm -rf $SCRATCH/rstudiotmp
```

--

- You have assess to a Hoffman2 terminal in RStudio

![](rstudio_terminal.gif)

---


## Using Batch R

When you install packages with this RStudio container, it uses R that
was built only for this container, separte from the R version on
Hoffman2.

You can run R inside this container if you want to continue using this
build of R as a batch/qsub job, instead of an interactive RStudio.

Create a job script, using the RStudio container, running with apptainer


```bash
#!/bin/bash
#$ -cwd
#$ -o rstudio_batch.out.$JOB_ID
#$ -j y
#$ -l h_rt=3:00:00,h_data=5G
#$ -pe shared 1

module load apptainer/1.0.0

apptainer exec $H2_CONTAINER_LOC/h2-rstudio_4.1.0.sif R CMD BATCH myRtest.R
```

Then run this job script


```bash
qsub rstudio_batch.job
```

---

## Thanks and Happy Computing!

&lt;p align = "center"&gt; &lt;img src="cat.png" width="90%"&gt; &lt;/p&gt; 


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
